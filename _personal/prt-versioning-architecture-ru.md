# 🔧 Архитектурная спецификация: Система версионирования конфигураций .prt

**Проект:** Engine Results Viewer  
**Функция:** Автоматическое отслеживание истории конфигураций  
**Версия:** Draft 1.0  
**Дата:** 3 ноября 2025  
**Статус:** 🟡 Обсуждение концепции

---

## 📋 Краткое резюме

**Проблема:** Когда инженер делает несколько расчётов в EngMod4T, файл .prt (snapshot конфигурации проекта) перезаписывается при каждом новом расчёте. Это приводит к потере исторических данных конфигурации - инженер не может понять, что изменилось между расчётом №1 и расчётом №15.

**Решение:** Автоматически версионировать .prt файлы по calculation marker. Каждый calculation marker ($baseline, $v2, $15 и т.д.) получает свой snapshot .prt. Инженер может просмотреть конфигурацию для любого расчёта и сравнить конфигурации между расчётами.

**Эффект:** 
- ✅ Полный audit trail эволюции проекта
- ✅ Понимание причинно-следственных связей (изменил длину header → +5 HP)
- ✅ Возможность "откатиться" к успешным конфигурациям
- ✅ Автоматическая документация (замена ручных Excel таблиц)

---

## 🎯 Описание проблемы

### Текущий workflow (EngMod4T)

```
Шаг 1: Настройка двигателя
├── Bore: 82.5mm, Stroke: 75.6mm
├── Exhaust header: 650mm, diameter 39.4mm
├── Intake: ITB system
└── Combustion: timing 14.7° @ 2000 RPM

Шаг 2: Запуск расчёта → marker: $baseline
├── EngMod4T генерирует .prt файл (snapshot конфигурации)
└── EngMod4T записывает результаты в .det/.pou

Шаг 3: Изменение параметров
└── Exhaust header: 650mm → 700mm

Шаг 4: Запуск расчёта → marker: $v2_longer_header
├── EngMod4T ПЕРЕЗАПИСЫВАЕТ .prt файл (новая конфигурация)
└── EngMod4T ДОБАВЛЯЕТ в .det/.pou (новые результаты)

❌ Проблема: .prt перезаписан → потеряна конфигурация для $baseline
```

### Текущее ручное решение

Инженер ведёт Excel таблицу:

| Marker | Description |
|--------|-------------|
| $baseline | Initial: header 650mm, timing 14.7° @ 2000 RPM |
| $v2_longer_header | Changed: header 650mm → 700mm |
| $v15_final | Changed: header 700mm, timing 25.0° @ 6000 RPM |

**Проблемы ручного подхода:**
- ⏰ Занимает время
- ❌ Легко забыть записать
- 📝 Неполные описания
- 🔍 Сложно найти точные различия

---

## 💡 Предлагаемое решение

### Автоматическое версионирование конфигураций

**Основная концепция:** Автоматически сохранять версию .prt файла для каждого calculation marker

**Workflow в Engine Viewer:**

```
1. Пользователь делает расчёт в EngMod4T:
   $baseline → EngMod4T создаёт .prt
   
2. Engine Viewer парсит проект:
   - Обнаруживает marker $baseline в .det
   - Проверяет, существует ли .metadata/prt-versions/$baseline.prt
   - Если НЕТ → копирует текущий .prt → сохраняет как $baseline.prt
   - Если ДА → пропускает (уже сохранён)
   
3. Пользователь изменяет параметры (header 650→700mm):
   EngMod4T ПЕРЕЗАПИСЫВАЕТ .prt
   
4. Пользователь делает расчёт:
   $v2 → EngMod4T обновляет .prt
   
5. Engine Viewer парсит проект:
   - Обнаруживает НОВЫЙ marker $v2 в .det
   - Копирует текущий .prt → сохраняет как $v2.prt
   
6. Через месяц пользователь хочет понять разницу:
   - Engine Viewer: "Compare $baseline vs $v2"
   - Diff показывает: Exhaust header: 650mm → 700mm
```

---

## 📁 Архитектура хранения

### Структура директорий

```
C:/4Stroke/TM Soft ShortCut/
├── TM Soft ShortCut.det             # Результаты (все расчёты)
├── TM Soft ShortCut.pou             # Результаты (все расчёты)
├── TM Soft ShortCut.prt             # Текущая конфигурация (последняя)
├── TM Soft ShortCut.eng             # Engine file
├── TM Soft ShortCut.exp             # Exhaust port
├── TM Soft ShortCut.ipo             # Inlet port
├── ... (другие файлы компонентов)
└── .metadata/                       # Метаданные Engine Viewer
    ├── project.json                 # Метаданные проекта (уже есть)
    └── prt-versions/                # НОВОЕ: Версии конфигураций
        ├── $baseline.prt
        ├── $v2_longer_header.prt
        ├── $v15_final.prt
        └── index.json               # Метаданные версий
```

### Формат index.json

```json
{
  "$baseline": {
    "createdAt": "2025-10-21T10:30:00Z",
    "capturedFrom": "TM Soft ShortCut.prt",
    "fileSize": 12456,
    "checksum": "sha256:abc123..."
  },
  "$v2_longer_header": {
    "createdAt": "2025-10-22T14:15:00Z",
    "capturedFrom": "TM Soft ShortCut.prt",
    "fileSize": 12460,
    "checksum": "sha256:def456...",
    "changesFrom": "$baseline",
    "changesCount": 3
  }
}
```

**Почему .metadata/?**
- ✅ Уже используется для метаданных проектов
- ✅ Скрытая папка - не захламляет директорию проекта
- ✅ Всё в одном месте
- ✅ Простой backup/sync
- ✅ Согласуется с существующей архитектурой

---

## ⚙️ Backend логика

### Trigger: Когда сохранять версию?

**Стратегия:** Сохранять при первом обнаружении нового marker

**Алгоритм:**

```javascript
function versionPrtFiles(projectPath) {
  // 1. Парсим .det/.pou, получаем все calculation markers
  const calculations = parseDetFile(projectPath).calculations;
  const markers = calculations.map(calc => calc.id); // ["$baseline", "$v2", ...]
  
  // 2. Читаем текущий .prt файл
  const currentPrt = readFile(`${projectPath}/project.prt`);
  
  // 3. Убеждаемся что .metadata/prt-versions/ существует
  const versionsDir = `${projectPath}/.metadata/prt-versions/`;
  ensureDirectoryExists(versionsDir);
  
  // 4. Загружаем или создаём index.json
  const index = loadIndex(versionsDir) || {};
  
  // 5. Для каждого marker проверяем, существует ли версия
  for (marker of markers) {
    const versionPath = `${versionsDir}/${marker}.prt`;
    
    if (!fileExists(versionPath)) {
      // Первый раз видим этот marker → сохраняем версию
      copyFile(currentPrt, versionPath);
      
      // Обновляем index
      index[marker] = {
        createdAt: new Date().toISOString(),
        capturedFrom: "project.prt",
        fileSize: getFileSize(currentPrt),
        checksum: calculateChecksum(currentPrt)
      };
      
      console.log(`✅ Сохранена версия конфигурации для ${marker}`);
    }
  }
  
  // 6. Сохраняем обновлённый index
  saveIndex(versionsDir, index);
}
```

**Когда выполнять:**
- При открытии проекта (фаза парсинга)
- При file system watch (если .det изменён)
- Кнопка "Обновить версии" вручную в UI

### API Endpoints

**Необходимые новые endpoints:**

```
GET /api/project/:id/prt-versions
→ Возвращает список всех сохранённых .prt версий

GET /api/project/:id/prt-versions/:marker
→ Возвращает конкретную версию .prt (распарсенную)

GET /api/project/:id/prt-versions/compare/:marker1/:marker2
→ Возвращает diff между двумя конфигурациями

POST /api/project/:id/prt-versions/:marker/save
→ Вручную сохранить текущий .prt как версию для marker
```

---

## 🎨 UI/UX дизайн

### 1. Новая вкладка: "Configuration History"

**Расположение:** ProjectPage, рядом с Charts и Data Table

```
┌─────────────────────────────────────────────────┐
│ [Charts] [Data Table] [Configuration History]  │ ← НОВАЯ ВКЛАДКА!
└─────────────────────────────────────────────────┘
```

**Содержимое:**

```
Configuration History для "TM Soft ShortCut"

┌──────────────────────────────────────────────────┐
│ 📋 $baseline                                     │
│ Начальная конфигурация                           │
│ Сохранена: 21 окт 2025, 10:30                   │
│                                                  │
│ [Просмотр конфигурации] [Сравнить с текущей]    │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│ 📋 $v2_longer_header                             │
│ 3 параметра изменено от $baseline               │
│ Сохранена: 22 окт 2025, 14:15                   │
│                                                  │
│ [Просмотр конфигурации] [Сравнить с $baseline]  │
└──────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────┐
│ 📋 $v15_final                                    │
│ 7 параметров изменено от $baseline              │
│ Сохранена: 25 окт 2025, 16:45                   │
│                                                  │
│ [Просмотр конфигурации] [Сравнить с любой...]   │
└──────────────────────────────────────────────────┘

[Ручные действия]
[🔄 Обновить версии] [💾 Сохранить текущую как...]
```

### 2. Configuration Viewer Modal

**Триггер:** Клик на "Просмотр конфигурации"

**Содержимое:** Красиво распарсенный .prt файл

```
┌─────────────────────────────────────────────────┐
│ Конфигурация: $baseline                         │
│                                           [✕]   │
├─────────────────────────────────────────────────┤
│                                                 │
│ ENGINE                                          │
│ • Type: 4-cylinder Inline, Naturally Aspirated │
│ • Bore × Stroke: 82.5 × 75.6 mm                │
│ • Displacement: 1616 cc                         │
│ • Compression Ratio: 11.3:1                     │
│ • Cylinder Head: Tumble Flow, 4 valves/cyl     │
│                                                 │
│ INTAKE SYSTEM                                   │
│ • Type: Individual Throttle Bodies (ITB)       │
│ • Throttles: 4 × Butterfly type                │
│ • Pipes: 8 total (4 cylinder + 4 throttle)     │
│                                                 │
│ EXHAUST SYSTEM                                  │
│ • Type: 4-into-1 collector                     │
│ • Header pipes: 4 × 650mm, Ø 39.4mm            │
│ • Collector: Ø 78.8mm → Ø 57mm                 │
│ • Exhaust box: 9000 cc                         │
│                                                 │
│ COMBUSTION                                      │
│ • Fuel: 100 Unleaded                           │
│ • Timing: 14.7° @ 2000 RPM → 29.4° @ 9000 RPM  │
│ • AFR: 12.57 @ 2000 RPM → 12.42 @ 9000 RPM     │
│                                                 │
│ [Экспорт в PDF] [Копировать в буфер]           │
└─────────────────────────────────────────────────┘
```

### 3. Configuration Diff Viewer

**Триггер:** Клик на "Сравнить с $baseline"

**Содержимое:**

```
┌─────────────────────────────────────────────────┐
│ Сравнение: $v2_longer_header vs $baseline      │
│                                           [✕]   │
├─────────────────────────────────────────────────┤
│                                                 │
│ EXHAUST SYSTEM                                  │
│ ● Header length: 650mm → 700mm                  │
│ ○ Header diameter: 39.4mm (не изменено)        │
│ ○ Collector: 78.8mm → 57mm (не изменено)       │
│                                                 │
│ COMBUSTION                                      │
│ ● Timing @ 6000 RPM: 23.5° → 25.0°             │
│ ● AFR @ 6000 RPM: 12.50 → 12.45                │
│ ○ Timing @ 2000 RPM: 14.7° (не изменено)       │
│                                                 │
│ НЕ ИЗМЕНЁННЫЕ СЕКЦИИ                            │
│ ○ Engine (bore, stroke, CR, cylinders)         │
│ ○ Intake system (ITB configuration)            │
│ ○ Firing order                                 │
│                                                 │
│ Легенда:                                        │
│ ● Изменено  ○ Не изменено                      │
│                                                 │
│ [Экспорт отчёта Diff] [Применить к текущей]    │
└─────────────────────────────────────────────────┘
```

**Приоритеты Diff алгоритма:**

**Критичные изменения (всегда показываем):**
- ✅ Exhaust system (длины, диаметры, collector)
- ✅ Intake system (ITB vs IM, размеры pipes)
- ✅ Combustion (timing, AFR по RPM)
- ✅ Engine основные (bore, stroke, CR)

**Вторичные изменения (показываем если изменились):**
- ⚠️ Valve timing (cam centers)
- ⚠️ Flowbench data
- ⚠️ Port dimensions

**Игнорируем (не показываем без явного запроса):**
- ○ Wall temperatures
- ○ Atmospheric conditions
- ○ Iteration cycles

---

## 🚀 Этапы реализации

### Этап 1: Backend основа (4-6 часов)
- [ ] Создать .prt parser (аналогично .det/.pou parsers)
- [ ] Реализовать логику версионирования в fileScanner.js
- [ ] Создать структуру директорий prt-versions/
- [ ] Реализовать управление index.json
- [ ] Добавить API endpoints для получения версий
- [ ] Тестирование с реальными .prt файлами

**Результат:** Backend может автоматически версионировать .prt файлы по marker

### Этап 2: Базовый UI (3-4 часа)
- [ ] Добавить вкладку "Configuration History" на ProjectPage
- [ ] Отображать список сохранённых версий
- [ ] Показывать базовые метаданные (дата, количество изменений)
- [ ] Ссылка на результаты расчёта (клик → просмотр графиков)

**Результат:** Пользователь может видеть список версий конфигураций

### Этап 3: Configuration Viewer (4-5 часов)
- [ ] Создать Configuration Viewer modal
- [ ] Парсить и отображать .prt красиво
- [ ] Организовать по секциям (Engine, Intake, Exhaust, Combustion)
- [ ] Добавить экспорт в PDF/text

**Результат:** Пользователь может просматривать детальную конфигурацию для любого расчёта

### Этап 4: Diff Viewer (5-7 часов)
- [ ] Реализовать алгоритм diff для .prt
- [ ] Создать Diff Viewer modal
- [ ] Подсветка изменённых/неизменённых параметров
- [ ] Категоризация изменений по приоритету
- [ ] Добавить функцию "Применить к текущей" (опционально)

**Результат:** Пользователь может сравнивать конфигурации и понимать изменения

### Этап 5: Расширенные функции (опционально)
- [ ] Кнопка "Сохранить конфигурацию" вручную
- [ ] Поиск/фильтр конфигураций
- [ ] Визуализация timeline
- [ ] Экспорт полного отчёта по истории конфигураций

**Общая оценка:** 16-22 часа (2-3 дня)

---

## 🔍 Критичные вопросы для обсуждения

### 1. Место хранения
**Текущее предложение:** `.metadata/prt-versions/`

**Альтернативы:**
- Вариант A: `.metadata/prt-versions/` (✅ рекомендуется)
- Вариант B: Отдельная база данных в папке приложения Engine Viewer
- Вариант C: В корне проекта (видимо для пользователя)

**Вопрос:** Подходит ли `.metadata/prt-versions/`?

---

### 2. Стратегия trigger
**Текущее предложение:** Сохранять версию при первом обнаружении нового marker

**Альтернативы:**
- Вариант A: При первом обнаружении (✅ автоматически)
- Вариант B: Кнопка "Сохранить" вручную для каждого расчёта
- Вариант C: При изменении .prt файла (file watcher)

**Вопрос:** Правильно ли автоматическое сохранение при первом обнаружении?

**Edge case:** Что если пользователь делает $test, удаляет его, потом снова делает $test с другой конфигурацией?
- Сейчас: Версия не обновится (первый $test уже сохранён)
- Решение: Кнопка "Пересохранить" вручную в UI

---

### 3. Приоритет UI
**Варианты:**
1. **Полная реализация** (History + Viewer + Diff) - 16-22 часа
2. **Минимальная версия** (History + базовый Viewer) - 7-10 часов
3. **Только Backend** (версионирование, без UI) - 4-6 часов

**Вопрос:** Какой приоритет? Можем начать с backend + минимальный UI?

---

### 4. Scope алгоритма Diff
**Вопрос:** Какие изменения КРИТИЧНЫ для подсветки?

**Текущее предложение:**
- ✅ Всегда показывать: Exhaust (длины, диаметры), Intake (тип, ITB/IM), Combustion (timing, AFR), Engine (bore, stroke, CR)
- ⚠️ Показывать если изменились: Valve timing, flowbench, ports
- ○ Скрывать по умолчанию: Temperatures, atmospheric, iterations

**Правильно?** Есть другие критичные параметры?

---

### 5. Интеграция с существующими функциями
**Вопрос:** Как Configuration History должна интегрироваться с графиками?

**Идеи:**
- A: Клик на конфигурацию → автоматически загрузить этот расчёт в графики
- B: Кнопка "Посмотреть результаты" → открывает расчёт
- C: Side-by-side: конфигурация + результаты в split view

**Предпочтение?**

---

### 6. Другие типы файлов
**Текущий scope:** Только версионирование .prt

**Вопрос:** Нужно ли версионировать другие файлы?
- `.eng` (конфигурация engine)
- `.exp` (exhaust port + cam)
- `.ipo` (inlet port + cam)
- `.cbd` (combustion data)

**Или .prt достаточно** (так как содержит summary всего)?

---

## 📊 Метрики успеха

**Качественные:**
- ✅ Инженер может понять, что изменилось между любыми двумя расчётами
- ✅ Больше не нужны ручные Excel таблицы
- ✅ Полный audit trail эволюции проекта
- ✅ Можно "откатиться" к успешным конфигурациям

**Количественные:**
- ⏱️ Экономия времени: ~5-10 минут на расчёт (нет ручной документации)
- 📈 При 50 расчётах/проект → экономия ~4-8 часов времени на документацию
- 🎯 100% точность отслеживания конфигураций (vs ~70% при ручном подходе)

---

## 🎯 Следующие шаги

**Для этого обсуждения:**
1. Обзор предложенной архитектуры
2. Ответы на критичные вопросы (1-6 выше)
3. Приоритизация функций (полная vs минимальная реализация)
4. Одобрение структуры хранения
5. Одобрение UI mockup'ов

**После одобрения:**
1. Создать технический roadmap для Claude Code
2. Создать ADR (Architecture Decision Record)
3. Обновить документацию
4. Начать реализацию

---

## 📝 Заметки и идеи

*(Место для совместных заметок во время обсуждения)*

**Feedback от Vladimir:**
- 

**Дополнительные идеи:**
- 

**Опасения:**
- 

**Принятые решения:**
- 

---

**Статус документа:** 🟡 Draft - ожидает обзора и feedback  
**Следующий обзор:** После feedback от Vladimir  
**Начало реализации:** После одобрения
