# ADR 001: Парсинг .det файлов

**Дата:** 21 октября 2025
**Статус:** Реализовано ✅
**Автор:** Вы + Claude Code

---

## Контекст

Приложение Engine Results Viewer должно читать результаты расчётов двигателей из файлов формата `.det`.

**Структура .det файла:**
```
Строка 1: Метаданные (NumCylinders EngineType)
Строка 2: Заголовки колонок (RPM, P-Av, Torque, ...)
Строка 3+: Маркеры расчётов ($1, $2...) + данные
```

**Пример** (test-data/Vesta 1.6 IM.det):
```
№  4 NATUR NumCyl
→  RPM  P-Av  Torque  PurCyl(1)  PurCyl(2)  ...
$1  1000  15.5  123.4  0.85  0.86  ...
$2  1500  22.3  150.2  0.88  0.87  ...
```

**Проблемы:**
1. Первая колонка служебная (символ →, номера строк) - нужно пропускать
2. Маркеры могут быть сложными: `$3.1 R 0.86`, `$2.1 0.86 _R`
3. Параметры могут быть массивами: `PurCyl(1-4)`, `TCylMax(1-4)`
4. Количество точек данных разное для каждого расчёта (~25-28 точек)

---

## Решение

Создан парсер **backend/src/services/fileParser.js** с тремя функциями:

1. **parseMetadata()** - парсинг строки 1
2. **parseColumnHeaders()** - парсинг строки 2
3. **parseCalculations()** - парсинг строки 3+

Данные конвертируются в стандартный JSON формат для frontend.

---

## Особенности реализации

### 1. Служебная первая колонка

**Проблема:** Первая колонка содержит служебные данные (→, номера строк).

**Решение:**
```javascript
const values = line
  .split(/\t+/)
  .slice(1)  // ← Пропускаем первую колонку!
  .map(v => v.trim());
```

### 2. Сложные маркеры расчётов

**Проблема:** Маркеры могут быть: `$1`, `$3.1`, `$3.1 R 0.86`

**Решение:**
```javascript
function parseMarker(firstValue) {
  return firstValue
    .replace(/^\$/, '')  // Убираем символ $
    .trim();
}
// $3.1 R 0.86 → "3.1 R 0.86"
```

### 3. Массивы параметров (PurCyl, TCylMax)

**Проблема:** Параметры типа `PurCyl(1-4)` разворачиваются в 4 колонки.

**Решение:**
```javascript
const paramPattern = /^(\w+)\((\d+)\)$/;
// "PurCyl(1)" → ["PurCyl", 1]

// В DataPoint хранятся как массивы:
{
  RPM: 1000,
  PurCyl: [0.85, 0.86, 0.87, 0.88],  // ← массив
  TCylMax: [450, 452, 448, 451]
}
```

### 4. Обработка вариативного количества данных

**Проблема:** Расчёты могут иметь разное количество точек (25-30).

**Решение:**
```javascript
// Читаем до конца файла или до следующего маркера
while (i < lines.length) {
  const line = lines[i];
  if (line.startsWith('$')) break;  // Новый расчёт

  dataPoints.push(parseDataPoint(line));
  i++;
}
```

---

## Выходной JSON формат

```json
{
  "metadata": {
    "cylinders": 4,
    "engineType": "NATUR"
  },
  "calculations": [
    {
      "id": "$1",
      "name": "Базовый расчёт",
      "data": [
        {
          "RPM": 1000,
          "P-Av": 15.5,
          "Torque": 123.4,
          "PurCyl": [0.85, 0.86, 0.87, 0.88],
          "TCylMax": [450, 452, 448, 451],
          "PCylMax": [85.2, 86.1, 85.8, 86.3],
          "TUbMax": [650, 652, 648, 651],
          "Deto": [0, 0, 0, 0],
          "Convergence": 0.0001
        }
      ]
    }
  ]
}
```

---

## Последствия

### Плюсы:
- ✅ Универсальный парсер (работает для любых .det файлов)
- ✅ Чистый JSON формат для frontend
- ✅ Поддержка сложных маркеров
- ✅ Обработка массивов параметров
- ✅ Обработка ошибок парсинга

### Минусы:
- ⚠️ Зависим от формата (если изменится - нужно обновлять парсер)
- ⚠️ Не валидируем корректность данных (только структуру)

---

## Тестирование

Протестировано на файлах:

| Файл | Расчётов | Строк | Статус |
|------|----------|-------|--------|
| `Vesta 1.6 IM.det` | 17 | 462 | ✅ OK |
| `BMW M42.det` | 30 | 804 | ✅ OK |

**Примеры маркеров:**
- ✅ Простые: `$1`, `$2`, `$3`
- ✅ С точкой: `$3.1`, `$9.3`
- ✅ Сложные: `$3.1 R 0.86`, `$2.1 0.86 _R`

---

## Реализация

**Файлы:**
- [backend/src/services/fileParser.js](../../backend/src/services/fileParser.js) (парсер)
- [backend/src/types/engineData.ts](../../backend/src/types/engineData.ts) (типы TypeScript)
- [shared-types.ts](../../shared-types.ts) (общие типы)

**API Endpoint:**
- `GET /api/project/:id` → возвращает распарсенные данные

**Roadmap:**
- Задача реализована в [Этапе 2](../../roadmap.md#этап-2-backend---базовая-структура)

---

## Будущее

В планах поддержка ещё ~5 форматов файлов (разные расширения):
- Каждый формат получит свой ADR
- Каждый формат получит свой парсер
- Все парсеры конвертируют в единый JSON формат (см. выше)

См. [docs/file-formats/README.md](../file-formats/README.md) для списка поддерживаемых форматов.

---

## Ссылки

- [Roadmap Этап 2](../../roadmap.md)
- [Тестовые данные](../../test-data/)
- [API документация](../api.md)
